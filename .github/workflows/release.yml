name: "Release"

on:
  push:
    tags:
      - "v*"

jobs:
  # First job: Build everything sequentially to avoid conflicts
  build-all:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev zip

      - name: Install frontend dependencies
        run: npm install

      - name: Download sidecar binaries (Linux)
        run: |
          mkdir -p src-tauri/bin
          TRIPLE="x86_64-unknown-linux-gnu"
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_linux -o src-tauri/bin/yt-dlp-$TRIPLE
          curl -L https://github.com/eugeneware/ffmpeg-static/releases/download/b5.0.1/linux-x64 -o src-tauri/bin/ffmpeg-$TRIPLE
          curl -L https://github.com/eugeneware/ffprobe-static/releases/download/b5.3.0/linux-x64 -o src-tauri/bin/ffprobe-$TRIPLE
          echo '#!/bin/bash' > src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          echo 'DIR="$(cd "$(dirname "$0")" && pwd)"' >> src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          echo 'exec "$DIR/yt-dlp" "$@"' >> src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          chmod +x src-tauri/bin/*

      - name: Build Linux
        run: npm run tauri build

      - name: Create Linux release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "VidFlow ${{ github.ref_name }}"
          body: |
            ## Download VidFlow
            
            Choose the appropriate version for your operating system:
            
            ### macOS
            - Apple Silicon (M1/M2/M3): `VidFlow_aarch64.zip`
            - Intel Mac: `VidFlow_x86_64.zip`
            
            **Instructions for macOS users:**  
            1. Download the ZIP  
            2. Extract it  
            3. Right-click → Open → Click Open (bypasses Gatekeeper)
            
            ### Windows
            - `VidFlow_x86_64-setup.exe`
            
            ### Linux
            - `VidFlow_x86_64.deb` or `.AppImage`
          draft: false
          prerelease: false
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Separate jobs for each platform - just build and upload using gh CLI
  build-macos-aarch64:
    needs: build-all
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - run: npm install
      - name: Download sidecar binaries
        run: |
          mkdir -p src-tauri/bin
          TRIPLE="aarch64-apple-darwin"
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o src-tauri/bin/yt-dlp-$TRIPLE
          curl -L https://github.com/eugeneware/ffmpeg-static/releases/download/b5.0.1/darwin-arm64 -o src-tauri/bin/ffmpeg-$TRIPLE
          curl -L https://github.com/eugeneware/ffprobe-static/releases/download/b5.3.0/darwin-arm64 -o src-tauri/bin/ffprobe-$TRIPLE
          echo '#!/bin/bash' > src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          echo 'DIR="$(cd "$(dirname "$0")" && pwd)"' >> src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          echo 'exec "$DIR/yt-dlp" "$@"' >> src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          chmod +x src-tauri/bin/*
      - name: Build
        run: npm run tauri build -- --target aarch64-apple-darwin
      - name: Create ZIP
        run: |
          APP_PATH=$(find src-tauri/target -name "*.app" -type d | head -1)
          cp -R "$APP_PATH" VidFlow.app
          xattr -dr com.apple.quarantine VidFlow.app || true
          chmod -R +x VidFlow.app/Contents/MacOS/*
          zip -r VidFlow_aarch64.zip VidFlow.app
      - name: Upload to Release
        run: |
          gh release upload ${{ github.ref_name }} VidFlow_aarch64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos-x86:
    needs: build-all
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - run: npm install
      - name: Download sidecar binaries
        run: |
          mkdir -p src-tauri/bin
          TRIPLE="x86_64-apple-darwin"
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o src-tauri/bin/yt-dlp-$TRIPLE
          curl -L https://github.com/eugeneware/ffmpeg-static/releases/download/b5.0.1/darwin-x64 -o src-tauri/bin/ffmpeg-$TRIPLE
          curl -L https://github.com/eugeneware/ffprobe-static/releases/download/b5.3.0/darwin-x64 -o src-tauri/bin/ffprobe-$TRIPLE
          echo '#!/bin/bash' > src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          echo 'DIR="$(cd "$(dirname "$0")" && pwd)"' >> src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          echo 'exec "$DIR/yt-dlp" "$@"' >> src-tauri/bin/yt-dlp-wrapper-$TRIPLE
          chmod +x src-tauri/bin/*
      - name: Build
        run: npm run tauri build -- --target x86_64-apple-darwin
      - name: Create ZIP
        run: |
          APP_PATH=$(find src-tauri/target -name "*.app" -type d | head -1)
          cp -R "$APP_PATH" VidFlow.app
          xattr -dr com.apple.quarantine VidFlow.app || true
          chmod -R +x VidFlow.app/Contents/MacOS/*
          zip -r VidFlow_x86_64.zip VidFlow.app
      - name: Upload to Release
        run: |
          gh release upload ${{ github.ref_name }} VidFlow_x86_64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: build-all
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: dtolnay/rust-toolchain@stable
      - run: npm install
      - name: Download sidecar binaries
        run: |
          mkdir -p src-tauri/bin
          $TRIPLE = "x86_64-pc-windows-msvc"
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe -o src-tauri/bin/yt-dlp-$TRIPLE.exe
          curl -L https://github.com/eugeneware/ffmpeg-static/releases/download/b5.0.1/win32-x64 -o src-tauri/bin/ffmpeg-$TRIPLE.exe
          curl -L https://github.com/eugeneware/ffprobe-static/releases/download/b5.0.1/win32-x64 -o src-tauri/bin/ffprobe-$TRIPLE.exe
          copy src-tauri/bin\yt-dlp-$TRIPLE.exe src-tauri/bin\yt-dlp-wrapper-$TRIPLE.exe
      - name: Build
        run: npm run tauri build
      - name: Upload to Release
        run: |
          Get-ChildItem src-tauri/target/release/bundle/nsis/*.exe | ForEach-Object { gh release upload ${{ github.ref_name }} $_.FullName --clobber }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
